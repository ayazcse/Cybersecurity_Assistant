<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel: AI Cyber Professor (Ephemeral)</title>
    <!-- Browser Tab Icon (Favicon) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fcd34d'%3E%3Cpath d='M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 15h2v2h-2v-2zm0-8h2v6h-2v-6z'/%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd7g05EHOJfxT9E9zY/cK/t2Q9tQd+Lz/tA9JzKzGj7k7M8U+E/2S5E8W+g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyber-blue': '#1e3a8a',
                        'cyber-dark': '#0f172a',
                        'cyber-light': '#f1f5f9',
                        'cyber-accent': '#3b82f6',
                        'action-green': '#10b981',
                        'action-purple': '#a855f7',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .chat-container {
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; }
        .chat-container::-webkit-scrollbar-track { background-color: #1e293b; }

        .user-message { background-color: #3b82f6; color: white; border-radius: 1rem 1rem 0 1rem; }
        .ai-message { background-color: #334155; color: #e2e8f0; border-radius: 1rem 1rem 1rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .loading-dot { animation: bounce 0.6s infinite alternate; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
        .tts-button:hover, .action-button:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-cyber-dark text-white min-h-screen font-sans flex flex-col antialiased">

    <div class="flex flex-col w-full max-w-4xl mx-auto h-screen p-4">

        <!-- Header -->
        <header class="p-4 rounded-xl mb-4 bg-cyber-blue shadow-lg flex items-center justify-between">
            <h1 class="text-3xl font-bold tracking-tight flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-yellow-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                Sentinel: Ephemeral
            </h1>
            <span id="skill-level" class="text-sm px-3 py-1 bg-yellow-600 rounded-full font-semibold">Cyber Professor</span>
        </header>
        
        <!-- Action Buttons for PDF and Image Generation -->
        <div class="flex justify-around space-x-4 mb-4 p-3 bg-gray-800 rounded-xl shadow-md">
            <button id="generate-pdf-button" class="action-button w-1/2 p-3 bg-action-green text-white rounded-lg font-semibold flex items-center justify-center hover:bg-green-600 transition disabled:bg-gray-500" disabled>
                <i class="fas fa-file-pdf mr-2"></i> Generate Notes PDF
            </button>
            <button id="generate-image-button" class="action-button w-1/2 p-3 bg-action-purple text-white rounded-lg font-semibold flex items-center justify-center hover:bg-purple-600 transition disabled:bg-gray-500" disabled>
                <i class="fas fa-image mr-2"></i> Generate Image
            </button>
        </div>

        <!-- Chat History Container -->
        <div id="chat-history" class="chat-container flex-grow space-y-4 p-3 mb-4 bg-gray-800 rounded-xl shadow-inner">
             <!-- Welcome message will be appended here -->
        </div>
        
        <!-- Image Preview Area (Hidden by default) -->
        <div id="image-preview-container" class="hidden p-4 mb-4 bg-gray-700 rounded-xl shadow-xl flex flex-col items-center">
            <h3 class="text-lg font-semibold mb-2 text-yellow-400">Generated Image</h3>
            <img id="generated-image" class="rounded-lg shadow-lg max-w-full h-auto" src="" alt="Generated image preview">
            <p id="image-prompt-display" class="text-sm text-gray-400 mt-2 italic"></p>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-gray-700 rounded-xl shadow-xl flex items-end sticky bottom-0">
            <input type="file" id="file-input" class="hidden" accept="image/*">
            
            <button id="attach-button" class="p-3 text-gray-300 hover:text-white transition rounded-full hover:bg-gray-600 flex-shrink-0" title="Attach Image for analysis">
                <i class="fa-solid fa-lock text-xl"></i>
            </button>
            <span id="file-name-display" class="text-sm text-yellow-400 mr-2 italic hidden flex-shrink-0"></span>

            <textarea id="user-input" class="flex-grow p-3 mx-2 bg-gray-800 text-white rounded-lg resize-none focus:ring-2 focus:ring-cyber-accent focus:outline-none w-full" 
                      placeholder="Ask a question, or type '/image [prompt]' or '/pdf' to generate content..." 
                      rows="1" 
                      style="max-height: 100px; overflow-y: auto;"></textarea>
            
            <button id="send-button" class="p-3 bg-cyber-accent text-white rounded-full hover:bg-blue-600 transition-colors shadow-md disabled:bg-gray-500 flex-shrink-0" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3v7l15 2-15 2v7z"/></svg>
            </button>
        </div>
    </div>

    <!-- Hidden Message Box (in lieu of alert) -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full text-center shadow-2xl border border-red-500">
            <h3 class="text-xl font-bold mb-3 text-red-400">Action Status</h3>
            <p id="message-content" class="text-gray-200"></p>
            <button onclick="document.getElementById('message-box').classList.add('hidden')" class="mt-4 px-4 py-2 bg-red-600 rounded hover:bg-red-700 transition">Close</button>
        </div>
    </div>

    <audio id="tts-player" style="display: none;"></audio>
    <div id="temp-download-link" style="display: none;"></div>

    <script>
        // --- Global Variables and Constants ---
        const API_KEY = "AIzaSyBgiXj9RSPEUhQyOLju1WazVPV7mqihaKs"; // Leave as is, Canvas provides this
        const GEMINI_TEXT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const IMAGEN_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict";
        const TTS_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";
        
        const MAX_RETRIES = 5;
        const TYPING_DELAY_MS = 30; // Faster speed for better feel
        
        let chatHistory = []; 
        let attachedFile = null;

        // --- DOM Elements ---
        const chatHistoryDiv = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const ttsPlayer = document.getElementById('tts-player');
        const pdfButton = document.getElementById('generate-pdf-button');
        const imageButton = document.getElementById('generate-image-button');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const generatedImage = document.getElementById('generated-image');
        const imagePromptDisplay = document.getElementById('image-prompt-display');


        // --- Utility Functions ---

        /** Shows a custom status message. */
        function showMessage(title, message, isError = true) {
            document.getElementById('message-content').textContent = message;
            document.getElementById('message-box').querySelector('h3').textContent = title;
            const borderEl = document.getElementById('message-box').querySelector('div');
            const buttonEl = document.getElementById('message-box').querySelector('button');

            if (isError) {
                 borderEl.classList.remove('border-green-500');
                 borderEl.classList.add('border-red-500');
                 buttonEl.classList.remove('bg-green-600', 'hover:bg-green-700');
                 buttonEl.classList.add('bg-red-600', 'hover:bg-red-700');
                 document.getElementById('message-box').querySelector('h3').classList.remove('text-green-400');
                 document.getElementById('message-box').querySelector('h3').classList.add('text-red-400');
            } else {
                 borderEl.classList.remove('border-red-500');
                 borderEl.classList.add('border-green-500');
                 buttonEl.classList.remove('bg-red-600', 'hover:bg-red-700');
                 buttonEl.classList.add('bg-green-600', 'hover:bg-green-700');
                 document.getElementById('message-box').querySelector('h3').classList.remove('text-red-400');
                 document.getElementById('message-box').querySelector('h3').classList.add('text-green-400');
            }

            document.getElementById('message-box').classList.remove('hidden');
        }

        /** Converts a File object to a Base64 string for API submission. */
        function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const mimeType = file.type;
                    const base64Data = e.target.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        /** Converts Base64 string to ArrayBuffer. Used for audio processing. */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /** Converts PCM audio data into a playable WAV Blob. */
        function pcmToWav(pcm16, sampleRate) {
            // ... (pcmToWav implementation remains the same as previous)
            const numChannels = 1;
            const bitsPerSample = 16;
            const dataLength = pcm16.length * (bitsPerSample / 8);

            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Sub-chunk size
            view.setUint16(20, 1, true); // Audio format (1 = PCM)
            view.setUint16(22, numChannels, true); // Number of channels
            view.setUint32(24, sampleRate, true); // Sample rate
            view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true); // Byte rate
            view.setUint16(32, numChannels * (bitsPerSample / 8), true); // Block align
            view.setUint16(34, bitsPerSample, true); // Bits per sample

            // DATA sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            // PCM Data
            var offset = 44;
            for (var i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([buffer], { type: 'audio/wav' });

            function writeString(view, offset, string) {
                for (var i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
        }

        /** Handles API calling with exponential backoff. */
        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + (Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `API call failed with status ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error?.message || errorMessage;
                    } catch {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                return response.json();
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + (Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw error;
            }
        }

        /** Cleans ALL Markdown formatting from text for smooth TTS playback and clean visual display. */
        function cleanTextForAudio(text) {
            text = text.replace(/\*\*(.*?)\*\*/gs, '$1');
            text = text.replace(/\*(.*?)\*/gs, '$1');
            text = text.replace(/```[^]*?```/gs, ' ');
            text = text.replace(/^\s*\-\s*/gm, ' ');
            text = text.replace(/#/g, ''); 
            return text.trim();
        }
        
        /** Cleans and prepares text for LaTeX (removes problematic characters and escapes what is necessary) */
        function cleanTextForLatex(text) {
             // Remove complex markdown/HTML
            let cleaned = text.replace(/<\/?(p|div|br|strong|em|b|i|h\d)\/?>/g, ''); // Remove basic HTML tags
            cleaned = cleaned.replace(/```.*?```/gs, ''); // Remove code blocks
            cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '$1'); // Remove bold markdown
            cleaned = cleaned.replace(/\*(.*?)\*/g, '$1'); // Remove italics markdown

            // LaTeX-specific escaping (order matters)
            cleaned = cleaned.replace(/\\/g, '\\textbackslash{}'); // Escape backslashes first
            cleaned = cleaned.replace(/&/g, '\\&');
            cleaned = cleaned.replace(/%/g, '\\%');
            cleaned = cleaned.replace(/\$/g, '\\$');
            cleaned = cleaned.replace(/#/g, '\\#');
            cleaned = cleaned.replace(/_/g, '\\_');
            cleaned = cleaned.replace(/{/g, '\\{');
            cleaned = cleaned.replace(/}/g, '\\}');
            cleaned = cleaned.replace(/~/g, '\\textasciitilde{}');
            cleaned = cleaned.replace(/\^/g, '\\textasciicircum{}');
            
            // Convert list markers for simple \item
            cleaned = cleaned.replace(/^\s*-\s*/gm, '\n\\item ');
            
            return cleaned.trim();
        }

        /** Simulates letter-by-letter typing effect. */
        function simulateTyping(element, text) {
            return new Promise(resolve => {
                let i = 0;
                element.textContent = ''; 
                function type() {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                        if (chatHistoryDiv.scrollHeight - chatHistoryDiv.clientHeight <= chatHistoryDiv.scrollTop + 50) {
                            scrollToBottom();
                        }
                        setTimeout(type, TYPING_DELAY_MS); 
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }

        // --- UI Rendering Functions ---

        /** Scrolls chat history to the bottom. */
        function scrollToBottom() {
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }
        
        /** Renders the initial welcome message and the entire chat history. */
        function renderChatHistory() {
            chatHistoryDiv.innerHTML = '';
            
            // Initial Welcome Message (no user ID needed since it's ephemeral)
            const welcomeMessageHTML = `
                <div class="flex justify-start">
                    <div class="ai-message p-3 max-w-3xl">
                        <p class="font-medium text-lg text-yellow-300">Welcome, Student. (Ephemeral Session)</p>
                        <p>I am Sentinel, your AI Cyber Professor. I can teach you everything from CIA Triad to Forensics. Your history will be erased when you close this tab.</p>
                        <p class="mt-2 text-sm">You can also use special commands:</p>
                        <ul class="list-disc list-inside ml-2 mt-1 text-gray-300">
                            <li>Type <span class="text-action-green">/pdf</span> and click the **Generate Notes PDF** button to download a summary of the current chat.</li>
                            <li>Type <span class="text-action-purple">/image [prompt]</span> (e.g., /image secure network topology diagram) to generate an image.</li>
                        </ul>
                    </div>
                </div>
            `;
            chatHistoryDiv.innerHTML = welcomeMessageHTML;

            // Render existing history
            chatHistory.forEach(item => {
                if (item.role === 'user' && item.parts.length > 0) {
                    const textPart = item.parts.find(p => p.text)?.text || '';
                    const filePart = item.parts.find(p => p.inlineData);
                    appendMessage('user', textPart, filePart, false, null); 
                } else if (item.role === 'model' && item.parts.length > 0) {
                    const rawText = item.parts[0].text;
                    const displayText = cleanTextForAudio(rawText);
                    appendMessage('model', displayText, null, false, null); 
                }
            });
            scrollToBottom();
        }

        /** Creates a message bubble in the UI. */
        function appendMessage(role, displayText, filePart, isTyping, audioUrl) {
            const isUser = role === 'user';
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `${isUser ? 'user-message' : 'ai-message'} p-3 max-w-lg flex items-start`;

            let contentHTML = '';
            if (filePart) {
                const fileType = filePart.inlineData.mimeType.startsWith('image/') ? 'Image' : 'File';
                contentHTML += `<p class="text-sm italic mb-2 opacity-80">Attached: ${fileType} for analysis</p>`;
            }

            const textElement = document.createElement('p');
            textElement.className = "whitespace-pre-wrap flex-grow";
            textElement.textContent = isTyping ? '' : displayText; 
            
            messageBubble.innerHTML = contentHTML;
            messageBubble.appendChild(textElement);

            let ttsButton = null;
            if (!isUser) {
                ttsButton = document.createElement('button');
                ttsButton.disabled = isTyping || !audioUrl;
                ttsButton.className = 'tts-button ml-3 p-1 text-yellow-300 hover:text-yellow-100 transition duration-150 rounded-full flex-shrink-0';
                ttsButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zM9.5 16.5v-9L16 12l-6.5 4.5z"/></svg>`;
                ttsButton.title = "Listen to response";
                
                if (!audioUrl) {
                    ttsButton.onclick = () => handleTTSPlayback(displayText, ttsButton);
                } 
                
                messageBubble.appendChild(ttsButton);
            }

            messageWrapper.appendChild(messageBubble);
            chatHistoryDiv.appendChild(messageWrapper);
            scrollToBottom();
            
            return { textElement, ttsButton };
        }

        /** Adds a typing indicator for the assistant. */
        function showTypingIndicator() {
            const indicatorWrapper = document.createElement('div');
            indicatorWrapper.id = 'typing-indicator';
            indicatorWrapper.className = 'flex justify-start';
            
            const indicator = document.createElement('div');
            indicator.className = 'ai-message p-3 max-w-xs flex space-x-1 items-center';
            indicator.innerHTML = `
                <span class="text-white font-medium">Sentinel (AI) is thinking...</span>
                <span class="loading-dot w-2 h-2 bg-yellow-400 rounded-full"></span>
                <span class="loading-dot w-2 h-2 bg-yellow-400 rounded-full"></span>
                <span class="loading-dot w-2 h-2 bg-yellow-400 rounded-full"></span>
            `;
            
            indicatorWrapper.appendChild(indicator);
            chatHistoryDiv.appendChild(indicatorWrapper);
            scrollToBottom();
        }

        /** Removes the typing indicator. */
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        /** Resets the height of the user input textarea to 1 row. */
        function resetInputHeight() {
            userInput.style.height = 'auto';
            userInput.rows = 1;
        }
        
        /** Disables/enables interactive elements during processing. */
        function setInterfaceActive(isActive) {
            sendButton.disabled = !isActive;
            pdfButton.disabled = !isActive;
            imageButton.disabled = !isActive;
            userInput.disabled = !isActive;
            attachButton.disabled = !isActive;
        }


        // --- TTS Functions ---

        async function handleTTSPlayback(text, button, audioUrl = null) {
            ttsPlayer.pause();
            ttsPlayer.currentTime = 0; 
            
            const playingIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 animate-pulse" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/></svg>`;
            const originalIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zM9.5 16.5v-9L16 12l-6.5 4.5z"/></svg>`;
            
            button.innerHTML = playingIcon;
            button.disabled = true;
            
            const onAudioEnd = () => {
                button.innerHTML = originalIcon;
                button.disabled = false;
                ttsPlayer.removeEventListener('ended', onAudioEnd);
                ttsPlayer.removeEventListener('error', onAudioEnd);
            };
            ttsPlayer.addEventListener('ended', onAudioEnd, { once: true });
            ttsPlayer.addEventListener('error', onAudioEnd, { once: true });

            if (!audioUrl) {
                 // --- API Call to Generate Audio ---
                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: `Act as a professional and firm cybersecurity professor. Read the following text: ${text}` }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Charon" }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const response = await fetchWithRetry(TTS_API_URL + `?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const part = response?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        audioUrl = URL.createObjectURL(wavBlob);
                    } else {
                        throw new Error("Invalid audio response structure or missing audio data.");
                    }
                } catch (error) {
                    console.error("TTS API Error:", error);
                    showMessage("TTS Error", `Failed to generate audio. ${error.message}`);
                    onAudioEnd();
                    return null;
                }
            } 
            
            if (audioUrl) {
                ttsPlayer.src = audioUrl; 
                ttsPlayer.play();
                return audioUrl; 
            }
            return null;
        }
        
        // --- PDF Generation Functions ---

        /** Generates the complete LaTeX content for a handwritten notes PDF. */
        function generateLatexDocument(title, content) {
            const today = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            
            const contentItems = content.split('\n\n').map(p => {
                if (p.trim().startsWith('-')) {
                    // Treat as list items
                    return p.split('\n').map(item => `\\item ${cleanTextForLatex(item.substring(1).trim())}`).join('\n');
                }
                return `\\noindent ${cleanTextForLatex(p.trim())}\n\n`;
            }).join('\n\n');

            return `
\\documentclass[12pt]{article}
\\usepackage{amsmath}
\\usepackage{geometry}
\\usepackage{fontspec}
\\usepackage{enumitem}
\\geometry{a4paper, margin=1in}

% Setting a "handwritten" font
\\setmainfont{TeX Gyre Heros} % Noto Sans is standard, but using TeX Gyre Heros for a slightly different look (still compiling)
\\setmonofont{TeX Gyre Heros}
\\usepackage{xcolor}

\\definecolor{darkblue}{RGB}{30, 70, 110}

\\pagestyle{empty} % No page numbers

\\begin{document}
\\color{darkblue}

% Title Box (Simulating a notes header)
\\begin{center}
\\LARGE\\textbf{Sentinel Study Notes}
\\vspace{0.2cm}
\\hrule
\\vspace{0.1cm}
\\small\\textit{Topic: ${cleanTextForLatex(title)}} \\hfill \\textit{Date: ${today}}
\\vspace{0.1cm}
\\hrule
\\end{center}

\\vspace{0.5cm}

% Main Content
\\noindent
\\begin{itemize}[label=$\\diamond$, itemsep=5pt]
${contentItems}
\\end{itemize}

\\vfill
\\noindent\\small\\textit{Generated by Sentinel: AI Cyber Professor (Ephemeral)}

\\end{document}
            `.trim();
        }

        /** Prompts the LLM to summarize the chat and initiates PDF download. */
        async function generatePdf() {
            setInterfaceActive(false);
            imagePreviewContainer.classList.add('hidden');
            showTypingIndicator();
            showMessage("Generating PDF...", "Sentinel is compiling the chat summary. Please wait.", false);
            
            const historyText = chatHistory
                .filter(msg => msg.role === 'model' && msg.parts?.[0]?.text)
                .map(msg => cleanTextForAudio(msg.parts[0].text))
                .join('\n\n---\n\n');

            if (!historyText) {
                removeTypingIndicator();
                setInterfaceActive(true);
                showMessage("PDF Error", "No AI content to summarize. Ask Sentinel a question first.", true);
                return;
            }

            const prompt = `Based on the following conversation snippets, generate a concise, structured, and easy-to-read summary of the key cybersecurity concepts discussed. The summary should be suitable for study notes.
            
            Conversation Snippets:
            ---
            ${historyText}
            ---
            
            Format the output as a title on the first line, followed by a double newline, and then the summary content. Use lists where appropriate. DO NOT use markdown headers or bolding.`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: "You are a summary generator for study notes." }] },
                    config: { temperature: 0.5 }
                };

                const response = await fetchWithRetry(GEMINI_TEXT_API_URL + `?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const rawSummary = response?.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate summary.";
                
                // Extract Title and Content
                const parts = rawSummary.split('\n\n', 2);
                const title = parts[0].trim().replace(/\n/g, ' ');
                const content = parts.length > 1 ? parts[1].trim() : "Summary content not available.";

                const latexContent = generateLatexDocument(title, content);
                
                // Download the generated LaTeX file
                const blob = new Blob([latexContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const tempLink = document.getElementById('temp-download-link');
                const a = document.createElement('a');
                a.href = url;
                a.download = `Sentinel_Notes_${title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20)}.tex`;
                tempLink.appendChild(a);
                a.click();
                tempLink.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage("PDF Ready", "LaTeX file generated successfully! Use a LaTeX compiler (like Overleaf or a local install) to convert it to a handwritten-style PDF.", false);
                
            } catch (error) {
                console.error("PDF Generation Error:", error);
                showMessage("PDF Generation Failed", `Error compiling summary or API error: ${error.message}.`, true);
            } finally {
                removeTypingIndicator();
                setInterfaceActive(true);
            }
        }
        
        // --- Image Generation Functions ---
        
        async function generateImage(imagePrompt) {
            setInterfaceActive(false);
            imagePreviewContainer.classList.add('hidden');
            showTypingIndicator();
            showMessage("Generating Image...", `Sentinel is creating an image for: "${imagePrompt}". This may take 15-30 seconds.`, false);
            
            try {
                const payload = { 
                    instances: { 
                        prompt: `A highly realistic, professional-grade visual representation of: ${imagePrompt}. Style: Concept art, cyberpunk, or abstract security diagram.`,
                    }, 
                    parameters: { 
                        "sampleCount": 1
                    } 
                };
                
                const response = await fetchWithRetry(IMAGEN_API_URL + `?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = response;
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                
                if (!base64Data) {
                     throw new Error("No image data received from the API.");
                }

                const imageUrl = `data:image/png;base64,${base64Data}`;

                // Display the image
                generatedImage.src = imageUrl;
                imagePromptDisplay.textContent = `Prompt: ${imagePrompt}`;
                imagePreviewContainer.classList.remove('hidden');
                
                // Scroll to the image preview
                imagePreviewContainer.scrollIntoView({ behavior: 'smooth' });

                showMessage("Image Ready", "Image generated successfully! It's displayed above.", false);

            } catch (error) {
                console.error("Image Generation Error:", error);
                showMessage("Image Generation Failed", `Error generating image: ${error.message}.`, true);
            } finally {
                removeTypingIndicator();
                setInterfaceActive(true);
            }
        }


        // --- Core Logic: Text Chat ---

        /** Handles the main chat submission and API call. */
        async function sendMessage() {
            const rawPrompt = userInput.value.trim();
            const file = attachedFile;

            if (!rawPrompt && !file) return;

            setInterfaceActive(false);
            imagePreviewContainer.classList.add('hidden');
            userInput.value = '';
            resetInputHeight();
            
            // --- Check for Special Commands ---
            if (rawPrompt.toLowerCase().startsWith('/image ')) {
                const imagePrompt = rawPrompt.substring(7).trim();
                if (imagePrompt) {
                    await generateImage(imagePrompt);
                } else {
                    showMessage("Image Command Error", "Please provide a prompt after /image (e.g., /image firewall rule diagram).", true);
                }
                setInterfaceActive(true);
                return;
            }
            if (rawPrompt.toLowerCase() === '/pdf') {
                // The /pdf command is now handled by the button's click handler, but we process it here for memory
                chatHistory.push({ role: "user", parts: [{ text: rawPrompt }] });
                appendMessage('user', rawPrompt, null, false, null);
                setInterfaceActive(true);
                return; 
            }
            // ------------------------------------

            attachedFile = null; 
            fileNameDisplay.classList.add('hidden');
            fileNameDisplay.textContent = '';
            
            // 1. Add User Message and show loading
            let newUserMessage = { role: "user", parts: [{ text: rawPrompt }] };
            if (file) {
                 newUserMessage.parts.push(await fileToGenerativePart(file));
            }
            
            chatHistory.push(newUserMessage);
            appendMessage('user', rawPrompt, file ? newUserMessage.parts[1] : null, false, null); 
            showTypingIndicator();

            // 2. Prepare API Payload
            const contents = [...chatHistory];

            const systemInstruction = "You are 'Sentinel,' a world-class Cybersecurity Professor and Virtual Assistant. Your expertise ranges from basic digital hygiene (CIA Triad, MFA) to professional topics (Penetration Testing, Forensics, Threat Hunting, GRC). Always adopt a formal, encouraging, and highly informative pedagogical style. Crucially, ensure your explanations use simple, clear, and easy-to-understand language, breaking down complex topics into digestible parts, suitable for a beginner or intermediate student. Use **Markdown** for formatting (like **bolding** keywords). Keep your responses concise yet thorough. Crucially, never break character or admit to being an LLM in the chat.";

            const payload = {
                contents: contents,
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                config: { temperature: 0.8 }
            };
            
            let rawAiText = "Sentinel encountered an unknown error. Please try again.";
            
            try {
                const response = await fetchWithRetry(GEMINI_TEXT_API_URL + `?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const candidate = response?.candidates?.[0];
                rawAiText = candidate?.content?.parts?.[0]?.text || rawAiText;
                
            } catch (error) {
                removeTypingIndicator();
                console.error("Gemini API Error:", error);
                showMessage("API Communication Error", `Failed to get response from Sentinel: ${error.message}.`, true);
                setInterfaceActive(true);
                return;
            }

            // 3. Start TTS generation 
            const cleanAiText = cleanTextForAudio(rawAiText);
            
            // Generate the URL (this will also kick off the visual loading state)
            const audioUrl = await handleTTSPlayback(cleanAiText, { disabled: true, innerHTML: '' }, false);

            // 4. Synchronization Moment: Remove loading, create bubble, and start sync
            removeTypingIndicator(); 
            
            const { textElement, ttsButton } = appendMessage('model', cleanAiText, null, true, audioUrl);
            
            if (audioUrl) {
                // Ensure the button is properly hooked up for replay
                ttsButton.onclick = () => handleTTSPlayback(cleanAiText, ttsButton, audioUrl);
                
                ttsPlayer.src = audioUrl;
                ttsPlayer.play();
                
                // Manual reset for the first audio playback (since handleTTSPlayback returns immediately)
                const originalIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zM9.5 16.5v-9L16 12l-6.5 4.5z"/></svg>`;
                ttsPlayer.addEventListener('ended', () => {
                     if(ttsButton.innerHTML.includes('animate-pulse')) {
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                     }
                }, { once: true });
            }

            // Start the typing effect
            await simulateTyping(textElement, cleanAiText); 

            // 5. Update Chat History
            chatHistory.push({ role: "model", parts: [{ text: rawAiText }] });

            setInterfaceActive(true);
        }

        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            renderChatHistory(); 
            setInterfaceActive(true);
            
            // Enable send button based on input (text or file)
            userInput.addEventListener('input', () => {
                const hasInput = userInput.value.trim().length > 0;
                sendButton.disabled = !(hasInput || attachedFile);
            });
            
            // Handle Enter key for submission (Shift+Enter for new line)
            userInput.addEventListener('keydown', (e) => {
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight) + 'px';

                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (userInput.value.trim().length > 0 || attachedFile) {
                        sendMessage();
                    }
                }
            });

            // Handle PDF and Image buttons
            pdfButton.addEventListener('click', () => {
                // Check if any AI message exists before generating
                const hasAiContent = chatHistory.some(msg => msg.role === 'model');
                if (hasAiContent) {
                    generatePdf();
                } else {
                    showMessage("Action Required", "Please ask Sentinel a question first to generate chat content for the PDF summary.", true);
                }
            });
            
            imageButton.addEventListener('click', () => {
                 // Check if the input contains a valid image command
                const currentText = userInput.value.trim().toLowerCase();
                if (currentText.startsWith('/image ')) {
                    const imagePrompt = currentText.substring(7).trim();
                    if (imagePrompt) {
                        // Clear input and send the command for execution
                        sendMessage();
                    } else {
                        showMessage("Command Error", "Please complete the /image command with a descriptive prompt.", true);
                    }
                } else {
                     showMessage("Command Error", "To generate an image, you must type the command: /image [Your Prompt Here]", true);
                }
            });


            // Handle file selection (only images for now)
            attachButton.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                         showMessage("File Error", "Only image files can be attached for analysis.", true);
                         fileInput.value = ''; // Clear selection
                         return;
                    }
                    attachedFile = file;
                    fileNameDisplay.textContent = `Attached: ${file.name}`;
                    fileNameDisplay.classList.remove('hidden');
                    sendButton.disabled = false;
                } else {
                    attachedFile = null;
                    fileNameDisplay.classList.add('hidden');
                    fileNameDisplay.textContent = '';
                    sendButton.disabled = !(userInput.value.trim().length > 0);
                }
            });

            sendButton.addEventListener('click', sendMessage);
        });
    </script>
</body>
</html>
